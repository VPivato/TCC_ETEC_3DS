{% extends 'shared/base.html' %}

{% block title %}Pedidos{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/shared/header_relative.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin/pedido/pedido-style.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin/pedido/pedido-escuro.css') }}">
{% endblock %}

{% block content %}

<main class="mt-5">
    <div id="esquerda">
        <div id="principal-esquerda">
            <h2 class="mb-4">Gestão de Pedidos</h2>
            <!-- Mais antigos ou mais recentes -->
            <form class="d-flex mb-3" method="get">
                <div class="input-group input-group-sm" style="max-width: 200px;">
                    <label class="input-group-text bg-light" for="ordenar">
                        <i class="bi bi-sort-down"></i>
                    </label>
                    <select class="form-select" id="ordenar" name="ordenar" onchange="this.form.submit()">
                        <option value="desc" {% if ordenar=='desc' %}selected{% endif %}>Mais recentes</option>
                        <option value="asc" {% if ordenar=='asc' %}selected{% endif %}>Mais antigos</option>
                    </select>
                </div>

                <!-- Preservar outros filtros -->
                <input type="hidden" name="status" value="{{ filtro_status }}">
                {% if campo_busca %}
                <input type="hidden" name="campo" value="{{ campo_busca }}">
                {% endif %}
                {% if termo_busca %}
                <input type="hidden" name="busca" value="{{ termo_busca }}">
                {% endif %}
                {% if data_inicio %}
                <input type="hidden" name="data_inicio" value="{{ data_inicio }}">
                {% endif %}
                {% if data_fim %}
                <input type="hidden" name="data_fim" value="{{ data_fim }}">
                {% endif %}
            </form>

            <!-- Botão para abrir/fechar filtro de datas -->
            <div class="mb-3">
                <button class="btn btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#filtroDatas"
                    aria-expanded="{{ 'true' if data_inicio or data_fim else 'false' }}" aria-controls="filtroDatas">
                    <i class="bi bi-calendar-range"></i> Filtro de datas
                </button>
            </div>

            <!-- Conteúdo colapsável do filtro de datas -->
            <div class="collapse {% if data_inicio or data_fim %}show{% endif %}" id="filtroDatas">
                <div class="card card-body border-0 shadow-sm mb-3">
                    <!-- FORM para envio dos filtros -->
                    <form method="get" action="{{ url_for('pedido.visualizar_pedidos') }}">
                        <div class="row g-2 align-items-end">
                            <div class="col">
                                <div class="form-floating">
                                    <input type="date" class="form-control" id="data_inicio" name="data_inicio"
                                        value="{{ data_inicio or '' }}">
                                    <label for="data_inicio">De</label>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-floating">
                                    <input type="date" class="form-control" id="data_fim" name="data_fim"
                                        value="{{ data_fim or '' }}">
                                    <label for="data_inicio">Até</label>
                                </div>
                            </div>
                            <div class="col-auto d-flex gap-2">
                                <button class="btn btn-outline-secondary" type="submit">
                                    <i class="bi bi-funnel"></i> Aplicar
                                </button>
                                <a class="btn btn-outline-secondary" href="{{ url_for('pedido.visualizar_pedidos',
                        status=filtro_status,
                        ordenar=ordenar,
                        campo=campo_busca,
                        busca=termo_busca) }}">
                                    Limpar
                                </a>
                            </div>
                        </div>

                        <!-- manter outros filtros na submissão -->
                        <input type="hidden" name="status" value="{{ filtro_status }}">
                        <input type="hidden" name="ordenar" value="{{ ordenar }}">
                        {% if campo_busca %}<input type="hidden" name="campo" value="{{ campo_busca }}">{% endif %}
                        {% if termo_busca %}<input type="hidden" name="busca" value="{{ termo_busca }}">{% endif %}
                    </form>
                </div>
            </div>

            <!-- Filtro por status do pedido -->
            <div class="mb-4">
                <div class="row g-2">
                    <div class="col-6 col-md">
                        <a href="{{ url_for('pedido.visualizar_pedidos',
                                status='pendente',
                                campo=request.args.get('campo'),
                                busca=request.args.get('busca'),
                                ordenar=request.args.get('ordenar'),
                                data_inicio=request.args.get('data_inicio'),
                                data_fim=request.args.get('data_fim')) }}"
                            class="btn w-100 btn-{{ 'primary' if filtro_status == 'pendente' else 'outline-primary' }}">
                            Pendentes
                        </a>
                    </div>
                    <div class="col-6 col-md">
                        <a href="{{ url_for('pedido.visualizar_pedidos',
                                status='retirado',
                                campo=request.args.get('campo'),
                                busca=request.args.get('busca'),
                                ordenar=request.args.get('ordenar'),
                                data_inicio=request.args.get('data_inicio'),
                                data_fim=request.args.get('data_fim')) }}"
                            class="btn w-100 btn-{{ 'success' if filtro_status == 'retirado' else 'outline-success' }}">
                            Retirados
                        </a>
                    </div>
                    <div class="col-6 col-md">
                        <a href="{{ url_for('pedido.visualizar_pedidos',
                                status='cancelado',
                                campo=request.args.get('campo'),
                                busca=request.args.get('busca'),
                                ordenar=request.args.get('ordenar'),
                                data_inicio=request.args.get('data_inicio'),
                                data_fim=request.args.get('data_fim')) }}"
                            class="btn w-100 btn-{{ 'danger' if filtro_status == 'cancelado' else 'outline-danger' }}">
                            Cancelados
                        </a>
                    </div>
                    <div class="col-6 col-md">
                        <a href="{{ url_for('pedido.visualizar_pedidos',
                                status='todos',
                                campo=request.args.get('campo'),
                                busca=request.args.get('busca'),
                                ordenar=request.args.get('ordenar'),
                                data_inicio=request.args.get('data_inicio'),
                                data_fim=request.args.get('data_fim')) }}"
                            class="btn w-100 btn-{{ 'secondary' if filtro_status == 'todos' else 'outline-secondary' }}">
                            Todos
                        </a>
                    </div>
                </div>
            </div>

            <!-- Pesquisa por coluna -->
            <form class="row g-2 align-items-center mb-4" method="get">
                <input type="hidden" name="status" value="{{ filtro_status }}">
                <input type="hidden" name="ordenar" value="{{ ordenar }}">
                <input type="hidden" name="data_inicio" value="{{ request.args.get('data_inicio') or '' }}">
                <input type="hidden" name="data_fim" value="{{ request.args.get('data_fim') or '' }}">

                <!-- Colunas para pesquisa -->
                <div class="col-auto">
                    <select name="campo" class="form-select" required>
                        <option value="">Pesquisar por...</option>
                        <option value="id_pedido" {% if request.args.get('campo')=='id_pedido' %}selected{% endif %}>ID
                            Pedido
                        </option>
                        <option value="id_usuario" {% if request.args.get('campo')=='id_usuario' %}selected{% endif %}>
                            ID
                            Usuário</option>
                        <option value="rm" {% if request.args.get('campo')=='rm' %}selected{% endif %}>RM</option>
                        <option value="codigo_etec" {% if request.args.get('campo')=='codigo_etec' %}selected{% endif
                            %}>
                            Código
                            ETEC</option>
                    </select>
                </div>

                <!-- Valor para pesquisa -->
                <div class="col-auto">
                    <input type="text" name="busca" class="form-control" placeholder="Digite o termo"
                        value="{{ request.args.get('busca') or '' }}" required>
                </div>

                <div class="btn-container">
                    <div class="col-auto">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-search"></i> Buscar
                        </button>
                    </div>
                    <div class="col-auto">
                        <a href="{{ url_for('pedido.visualizar_pedidos', status='pendente') }}"
                            class="btn btn-secondary">
                            Limpar
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="direita">
        <div id="container-pedidos">
            {% if pedidos %}
            {% for pedido in pedidos %}
            <div class="card mb-3 shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div class="w-100" data-bs-toggle="collapse" data-bs-target="#pedido{{ pedido.id }}"
                        aria-expanded="false" role="button">

                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="mb-0">Pedido #{{ pedido.id }}</h6>
                                <small class="text-muted">
                                    ID Usuário: {{ pedido.usuario.id }}
                                </small>

                                <!-- Informações extras só aparecem quando o card está expandido -->
                                <div class="collapse mt-1" id="info-header-{{ pedido.id }}">
                                    <small class="text-muted d-block">
                                        {% if pedido.usuario.nivel_conta == 0 %}
                                        Nome: {{ pedido.usuario.aluno.nome_aluno }}<br>
                                        {% else %}
                                        Nome: Admin {{ pedido.usuario.rm_usuario }}<br>
                                        {% endif %}
                                        Código ETEC: {{ pedido.usuario.codigo_etec_usuario }}<br>
                                        RM: {{ pedido.usuario.rm_usuario }}
                                    </small>
                                </div>
                            </div>

                            <div class="text-end">
                                <span class="badge bg-{{ 
                    'warning' if pedido.status == 'pendente' else 
                    'success' if pedido.status == 'retirado' else 
                    'danger' 
                }}">
                                    {{ pedido.status.capitalize() }}
                                </span>
                                <br>
                                <small class="text-muted">
                                    {{ pedido.data_hora.strftime('%d/%m/%Y %H:%M') }}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="pedido{{ pedido.id }}" class="collapse pedido-body">
                    <div class="card-body">
                        <h6>Itens do Pedido:</h6>
                        <ul class="list-group mb-3">
                            {% for item in pedido.itens %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>{{ item.produto.descricao_produto }}<br>
                                    Quantidade: {{ item.quantidade }} x R$ {{ '%.2f'|format(item.preco_unitario) }}
                                </div>
                                <div>
                                    <strong>R$ {{ '%.2f'|format(item.quantidade * item.preco_unitario) }}</strong>
                                </div>
                            </li>
                            {% endfor %}
                        </ul>

                        <div class="text-end">
                            <h5>Total: <strong>R$ {{ '%.2f'|format(pedido.total) }}</strong></h5>
                        </div>
                    </div>

                    <div class="card-footer text-end">
                        {% if pedido.status == 'pendente' %}
                        <form action="{{ url_for('pedido.finalizar_pedido', pedido_id=pedido.id) }}" method="post"
                            class="d-inline">
                            <button type="button" class="btn btn-success btn-sm"
                                onclick="confirmarFinalizacao('{{ pedido.id }}')">
                                Marcar como Retirado
                            </button>
                        </form>
                        <form action="{{ url_for('pedido.cancelar_pedido', pedido_id=pedido.id) }}" method="post"
                            class="d-inline">
                            <button type="button" class="btn btn-danger btn-sm"
                                onclick="confirmarCancelamento('{{ pedido.id }}')">
                                Cancelar Pedido
                            </button>
                        </form>
                        {% elif pedido.status == 'retirado' %}
                        <button class="btn btn-secondary btn-sm" disabled>Pedido Retirado</button>
                        {% elif pedido.status == 'cancelado' %}
                        <button class="btn btn-secondary btn-sm" disabled>Pedido Cancelado</button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="nenhum-pedido alert alert-info">
                Nenhum pedido encontrado.
            </div>
            {% endif %}
        </div>
        {% if pagination.pages > 1 %}
        <nav aria-label="Navegação de páginas">
            <ul class="pagination justify-content-center flex-column flex-sm-row gap-2">

                <!-- Botão "Anterior" -->
                <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                    <a class="page-link text-center" href="{{ url_for('pedido.visualizar_pedidos',
                        page=pagination.prev_num,
                        status=filtro_status,
                        ordenar=ordenar,
                        campo=campo_busca,
                        busca=termo_busca,
                        data_inicio=request.args.get('data_inicio'),
                        data_fim=request.args.get('data_fim')) }}">
                        Anterior
                    </a>
                </li>

                <!-- Números -->
                <li>
                    <ul class="pagination justify-content-center mb-0 flex-wrap">
                        {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                        {% if p %}
                        <li class="page-item {% if p == pagination.page %}active{% endif %}">
                            <a class="page-link" href="{{ url_for('pedido.visualizar_pedidos',
                                page=p,
                                status=filtro_status,
                                ordenar=ordenar,
                                campo=campo_busca,
                                busca=termo_busca,
                                data_inicio=request.args.get('data_inicio'),
                                data_fim=request.args.get('data_fim')) }}">{{ p }}
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled"><span class="page-link">…</span></li>
                        {% endif %}
                        {% endfor %}
                    </ul>
                </li>

                <!-- Botão "Próximo" -->
                <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                    <a class="page-link text-center" href="{{ url_for('pedido.visualizar_pedidos',
                        page=pagination.next_num,
                        status=filtro_status,
                        ordenar=ordenar,
                        campo=campo_busca,
                        busca=termo_busca,
                        data_inicio=request.args.get('data_inicio'),
                        data_fim=request.args.get('data_fim')) }}">
                        Próximo
                    </a>
                </li>
            </ul>
        </nav>
        {% endif %}

    </div>
</main>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/admin/pedido/pedido-script.js') }}"></script>
{% endblock %}