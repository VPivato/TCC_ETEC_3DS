{% extends 'shared/base.html' %}

{% block title %}Relatórios{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/shared/header_relative.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin/relatorio/relatorio-style.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin/relatorio/relatorio-escuro.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <h1 class="mb-4">Relatórios</h1>


    <div class="container-fluid mt-4">
        <!-- Filtro de datas -->
        <div class="card mb-4 shadow-sm">
            <div class="card-body">
                <form id="filtroDatas" class="row g-3 align-items-end" method="get"
                    action="{{ url_for('relatorio.relatorio') }}">
                    <div class="col">
                        <label for="periodo" class="form-label">Período</label>
                        <select class="form-select" id="periodo" name="periodo">
                            <option value="hoje" {% if periodo=='hoje' %}selected{% endif %}>Hoje</option>
                            <option value="ultima_semana" {% if periodo=='ultima_semana' %}selected{% endif %}>Últimos 7
                                dias</option>
                            <option value="ultimo_mes" {% if periodo=='ultimo_mes' %}selected{% endif %}>Últimos 30 dias
                            </option>
                            <option value="comeco_ano" {% if periodo=='comeco_ano' %}selected{% endif %}>Começo do Ano
                            </option>
                            <option value="personalizado" {% if periodo=='personalizado' %}selected{% endif %}>
                                Personalizado</option>
                        </select>
                    </div>

                    <div class="col campo-data" {% if periodo !='personalizado' %}style="display:none;" {% endif %}>
                        <label for="dataInicio" class="form-label">Data Início</label>
                        <input type="date" class="form-control" id="dataInicio" name="dataInicio"
                            value="{{ data_inicio }}">
                    </div>

                    <div class="col campo-data" {% if periodo !='personalizado' %}style="display:none;" {% endif %}>
                        <label for="dataFim" class="form-label">Data Fim</label>
                        <input type="date" class="form-control" id="dataFim" name="dataFim" value="{{ data_fim }}">
                    </div>

                    <div class="col">
                        <button type="submit" class="btn btn-primary w-100">
                            Filtrar
                        </button>
                    </div>

                    <div class="col">
                        <a href="{{ url_for('relatorio.relatorio') }}" class="btn btn-secondary w-100">
                            Limpar Filtro
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Abas de navegação -->
        <ul class="nav nav-tabs" id="relatoriosTabs" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="geral-tab" data-bs-toggle="tab" data-bs-target="#geral"
                    type="button" role="tab">Geral</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="produtos-tab" data-bs-toggle="tab" data-bs-target="#produtos" type="button"
                    role="tab">Produtos</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="clientes-tab" data-bs-toggle="tab" data-bs-target="#clientes" type="button"
                    role="tab">Clientes</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="pedidos-tab" data-bs-toggle="tab" data-bs-target="#pedidos" type="button"
                    role="tab">Pedidos</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="pedidos-tab" data-bs-toggle="tab" data-bs-target="#feedbacks" type="button"
                    role="tab">Feedbacks</button>
            </li>
        </ul>

        <!-- Conteúdo das abas -->
        <div class="tab-content mt-3">
            <!-- Relatório Geral -->
            <div class="tab-pane fade show active" id="geral" role="tabpanel">
                <!-- KPIs -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-light shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title">Vendas Totais</h5>
                                <h3 class="fw-bold">R$ {{ "%.2f" | format(geral.kpis.vendas_totais) }}</h3>
                                <small>{{ periodo_formatado }}</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title">Pedidos</h5>
                                <h3 class="fw-bold">{{ geral.kpis.total_pedidos }}</h3>
                                <small>{{ periodo_formatado }}</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title">Clientes Atendidos</h5>
                                <h3 class="fw-bold">{{ geral.kpis.clientes_atendidos }}</h3>
                                <small>{{ periodo_formatado }}</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title">Venda Média</h5>
                                <h3 class="fw-bold">R$ {{ "%.2f" | format(geral.kpis.venda_media) }}</h3>
                                <small>{{ periodo_formatado }}</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gráficos -->
                <div class="row mb-4">
                    <!-- Vendas por Dia -->
                    <div class="col-md-6">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title">Vendas por Dia (R$)</h5>
                                <canvas id="graficoVendasDia"
                                    data-labels='{{ geral.grafico_vendas_dia.labels | tojson }}'
                                    data-valores='{{ geral.grafico_vendas_dia.valores | tojson }}'></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Participação por Produto -->
                    <div class="col-md-6">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title">Vendas por produto (un.)</h5>
                                <canvas id="graficoProdutos" data-labels='{{ geral.grafico_produtos.labels | tojson }}'
                                    data-valores='{{ geral.grafico_produtos.valores | tojson }}'></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Relatório de Produtos -->
            <div class="tab-pane fade" id="produtos" role="tabpanel">
                <!-- KPIs Produtos -->
                <div class="row g-3 mb-4 text-center">
                    <div class="col-md-3 col-6">
                        <div class="p-3 bg-light rounded shadow-sm card">
                            <h6 class="text-muted">Total de Produtos</h6>
                            <h4 class="fw-bold" id="kpi-total-produtos">{{ produto.kpis.total_produtos }}</h4>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="p-3 bg-light rounded shadow-sm card">
                            <h6 class="text-muted">Produtos Esgotados</h6>
                            <h4 class="fw-bold text-danger" id="kpi-produtos-esgotados">{{
                                produto.kpis.produtos_esgotados }}</h4>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="p-3 bg-light rounded shadow-sm card">
                            <h6 class="text-muted">Estoque Baixo (&le; 5)</h6>
                            <h4 class="fw-bold text-warning" id="kpi-produtos-estoque-baixo">{{
                                produto.kpis.produtos_estoque_baixo }}</h4>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="p-3 bg-light rounded shadow-sm card">
                            <h6 class="text-muted">Estoque total</h6>
                            <h4 class="fw-bold" id="kpi-preco-medio">{{ produto.kpis.estoque_total }}</h4>
                        </div>
                    </div>
                </div>

                <!-- Gráficos -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title">Produtos com estoque baixo</h5>
                                <canvas id="graficoEstoqueBaixo" height="300px"
                                    data-labels='{{ produto.grafico_estoque_baixo.labels | tojson }}'
                                    data-valores='{{ produto.grafico_estoque_baixo.valores | tojson }}'></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title">Vendas por categoria (R$)</h5>
                                <canvas id="graficoVendasCategoria" height="300px"
                                    data-labels='{{ produto.grafico_vendas_categoria.labels | tojson }}'
                                    data-valores='{{ produto.grafico_vendas_categoria.valores | tojson }}'></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filtro Produto -->
                <div class="card mb-4 shadow-sm">
                    <div class="card-body">
                        <form id="filtroProdutoForm" class="row g-3 align-items-center">
                            <div class="col-md-6">
                                <label for="produtoBusca" class="form-label">Buscar Produto (nome ou ID)</label>
                                <input type="text" id="produtoBusca" name="produtoBusca" class="form-control"
                                    placeholder="Ex: Coxinha, 15">
                            </div>
                            <div class="col-md-3">
                                <button type="button" id="btnBuscarProduto"
                                    class="btn btn-primary w-100">Buscar</button>
                            </div>
                            <div class="col-md-3">
                                <button type="button" id="btnLimparBusca"
                                    class="btn btn-secondary w-100">Limpar</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Informações produto específico -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h5 class="mb-2">Informações do Produto Selecionado</h5>
                                <ul class="list-group list-group-flush fs-6">
                                    <li class="list-group-item d-flex justify-content-between align-items-center li-prod">
                                        <span>Descrição</span>
                                        <span class="fw-bold" id="descricaoProduto">--</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center li-prod">
                                        <span>Categoria</span>
                                        <span class="fw-bold" id="categoriaProduto">--</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center li-prod">
                                        <span>Faturamento</span>
                                        <span class="fw-bold text-success" id="faturamentoProduto">R$ 0</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center li-prod">
                                        <span>Vendas</span>
                                        <span class="fw-bold" id="vendasProduto">0</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center li-prod">
                                        <span>Estoque Atual</span>
                                        <span class="fw-bold" id="estoqueProduto">0 unidades</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center li-prod">
                                        <span>Presente em</span>
                                        <span class="fw-bold" id="presenteEm">0% dos pedidos</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center li-prod">
                                        <span>Participação no faturamento total</span>
                                        <span class="fw-bold" id="participacaoTotal">0%</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h5 class="mb-0">Vendas do Produto Selecionado (R$)</h5>
                                <canvas id="graficoVendasProduto" height="300px"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Relatório de Clientes -->
            <div class="tab-pane fade" id="clientes" role="tabpanel">
                <!-- KPIs de Clientes -->
                <div class="row text-center mb-4">
                    <div class="col-md-3">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h6 class="text-muted">Total de Clientes</h6>
                                <h4 class="fw-bold">{{ clientes.kpis.total_clientes }}</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h6 class="text-muted">Novos no Período</h6>
                                <h4 class="fw-bold text-success">{{ clientes.kpis.novos_clientes }}</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h6 class="text-muted">Clientes Ativos</h6>
                                <h4 class="fw-bold">to do</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h6 class="text-muted">Clientes Inativos</h6>
                                <h4 class="fw-bold text-danger">to do</h4>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gráfico de Crescimento -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title">Crescimento de Clientes</h5>
                                <canvas id="graficoCrescimentoClientes" height="120"
                                    data-labels='{{ clientes.grafico.labels | tojson }}'
                                    data-valores='{{ clientes.grafico.valores | tojson }}'>
                                </canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lista de Top Clientes -->
                <div class="row">
                    <div class="col-12">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title">Top Clientes (por faturamento)</h5>
                                <div class="table-responsive">
                                    <table class="table table-hover" id="table-topCli">
                                        <thead>
                                            <tr>
                                                <th>Nome</th>
                                                <th>Código ETEC</th>
                                                <th>Email</th>
                                                <th>Total de Pedidos</th>
                                                <th>Faturamento Total (R$)</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for cliente in clientes.top_clientes %}
                                            <tr>
                                                <td>{{ cliente.nome }}</td>
                                                <td>{{ cliente.codigo_etec }}</td>
                                                <td>{{ cliente.email }}</td>
                                                <td>{{ cliente.total_pedidos }}</td>
                                                <td>R$ {{ "{:,.2f}".format(cliente.faturamento_total) }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Relatório de Pedidos -->
            <div class="tab-pane fade" id="pedidos" role="tabpanel">
                <!-- KPIs -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center shadow-sm">
                            <div class="card-body">
                                <h6 class="text-muted">Faturamento</h6>
                                <h4 class="mb-0">R$ {{ "%.2f" | format(pedidos.kpis.faturamento) }}</h4>
                                <small class="text-success">{{ pedidos.kpis.variacao_faturamento}}</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center shadow-sm">
                            <div class="card-body">
                                <h6 class="text-muted">Total de Pedidos</h6>
                                <h4 class="mb-0">{{ pedidos.kpis.total_pedidos }}</h4>
                                <small class="text-primary">{{ pedidos.kpis.variacao_pedidos}}</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center shadow-sm">
                            <div class="card-body">
                                <h6 class="text-muted">Taxa de Cancelamento</h6>
                                <h4 class="mb-0">{{ pedidos.kpis.taxa_cancelamento }}%</h4>
                                <small class="text-danger">{{ pedidos.kpis.variacao_cancelamento }}</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center shadow-sm">
                            <div class="card-body">
                                <h6 class="text-muted">Venda Média</h6>
                                <h4 class="mb-0">R$ {{ "%.2f" | format(pedidos.kpis.valor_medio_pedido) }}</h4>
                                <small class="text-muted">{{ pedidos.kpis.variacao_valor_medio }}</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gráficos -->
                <div class="row">
                    <!-- Donut de status dos pedidos -->
                    <div class="col-md-6 mb-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-header">
                                <h6 class="mb-0">Status dos Pedidos</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="graficoStatusPedidos" data-labels='{{ pedidos.grafico.labels | tojson }}'
                                    data-valores='{{ pedidos.grafico.valores | tojson }}'></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Linha de faturamento -->
                    <div class="col-md-6 mb-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-header">
                                <h6 class="mb-0">Faturamento Diário</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="graficoFaturamentoDiario"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Insights adicionais -->
                <div class="card shadow-sm mt-3">
                    <div class="card-header">
                        <h6 class="mb-0">Resumo de Destaques</h6>
                    </div>
                    <div class="card-body">
                        {% for f in pedidos.frases %}
                        <p>{{f|safe}}</p>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Relatório de Feedbacks -->
            <div class="tab-pane fade" id="feedbacks" role="tabpanel">
                <!-- KPIs -->
                <div class="row mb-4">
                    <div class="col">
                        <div class="card shadow-sm rounded-3 p-3 text-center">
                            <h6>Total de Feedbacks</h6>
                            <h2 id="kpi-total-feedbacks" class="fw-bold text-primary">{{ feedbacks.kpis.total_feedbacks
                                }}</h2>
                        </div>
                    </div>

                    <div class="col">
                        <div class="card shadow-sm rounded-3 p-3 text-center">
                            <h6>Dúvidas</h6>
                            <h2 id="kpi-duvidas" class="fw-bold text-info">{{ feedbacks.kpis.duvidas }}</h2>
                        </div>
                    </div>

                    <div class="col">
                        <div class="card shadow-sm rounded-3 p-3 text-center">
                            <h6>Reclamações</h6>
                            <h2 id="kpi-reclamacoes" class="fw-bold text-danger">{{ feedbacks.kpis.reclamacoes }}</h2>
                        </div>
                    </div>

                    <div class="col">
                        <div class="card shadow-sm rounded-3 p-3 text-center">
                            <h6>Sugestões</h6>
                            <h2 id="kpi-sugestoes" class="fw-bold text-warning">{{ feedbacks.kpis.sugestoes }}</h2>
                        </div>
                    </div>

                    <div class="col">
                        <div class="card shadow-sm rounded-3 p-3 text-center">
                            <h6>Elogios</h6>
                            <h2 id="kpi-elogios" class="fw-bold text-success">{{ feedbacks.kpis.elogios }}</h2>
                        </div>
                    </div>
                </div>

                <!-- Gráficos -->
                <div class="row">
                    <!-- Gráfico de pizza: proporção por tipo -->
                    <div class="col-md-6 mb-4">
                        <div class="card shadow-sm rounded-3 p-3 h-100">
                            <h5 class="fw-bold mb-3">Distribuição por Tipo</h5>
                            <canvas id="grafico-feedback-tipo" data-labels='{{ feedbacks.grafico_tipo.labels }}'
                                data-valores='{{ feedbacks.grafico_tipo.valores }}'></canvas>
                        </div>
                    </div>

                    <!-- Gráfico de linha: evolução ao longo do tempo -->
                    <div class="col-md-6 mb-4">
                        <div class="card shadow-sm rounded-3 p-3 h-100">
                            <h5 class="fw-bold mb-3">Evolução dos Feedbacks</h5>
                            <canvas id="grafico-feedback-tempo" data-labels='{{ feedbacks.grafico_tempo.labels }}' data-valores='{{ feedbacks.grafico_tempo.valores }}'></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/admin/relatorio/relatorio-script.js') }}"></script>

<!-- Chart.js para gráficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Chart.js plugin -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
{% endblock %}